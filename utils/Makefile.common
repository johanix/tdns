COMMIT:=`git describe --dirty=+WiP --always`
VERSION=`cat ../VERSION`
APPDATE=`date +"%Y-%m-%d-%H:%M"`

GOFLAGS:=-v -ldflags "-X app.version=$(VERSION)-$(COMMIT)"

GOOS ?= $(shell uname -s | tr A-Z a-z)

default: ${PROG}

${PROG}: build

version.go:	../VERSION Makefile
	/bin/sh ../utils/make-version.sh $(VERSION)-$(COMMIT) $(APPDATE) $(PROG)

build:	version.go
	$(GO) build $(GOFLAGS) -o ${PROG}

netbsd:	version.go
	GOOS=netbsd GOARCH=amd64 $(GO) build $(GOFLAGS) -o ${PROG}.netbsd

# johaniaws: Sync local tdns source to remote AWS environment.
# Requires: sshfs mount at ~/sshfs/msigner1
TDNS_SRC ?= ~/src/git/tdns
TDNS_AWS_DIR ?= ~/sshfs/msigner1/src/tdns

johaniaws:
	rsync --exclude=.git --exclude-from=${TDNS_SRC}/.gitignore -avx ${TDNS_SRC}/ ${TDNS_AWS_DIR}/

test:
	$(GO) test -v -cover

clean:
	@rm -f $(PROG)

# install:
# 	install -s -b -c ${PROG} /usr/local/bin/

lint:
	go fmt ./...
	go vet ./...
	staticcheck ./...
	gosec ./...
	golangci-lint run

.PHONY: build clean
